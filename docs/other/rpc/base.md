## 基本概念

RPC 的主要功能目标是让构建分布式计算（应用）更容易，在提供强大的远程调用能力时不损失本地调用的语义简洁性。比如服务 A 想要调用服务 B 上的某个方法/函数，使用方可以忽略底层的传输层的细节，专注于方法的使用。就像调用一个本地函数，使用十分便捷，不需要关心接口的 url，校验规则，返回值解析等过程。

## 基本实现

### RPC 实现基础

- 需要有非常高效的网络通信，比如一般选择 Netty 作为网络通信框架
- 需要有比较高效的序列化框架，比如 Protobuf
- 可靠的寻址方式（主要是提供服务的发现），比如可以使用 Zoo keeper 来注册服务等等
- 如果是带会话（状态）的 RPC 调用，还需要有会话和状态保持的功能

一个基本的 RPC 架构里面应该至少包含以下 4 个组件：

- 客户端（Client）：服务调用方（服务消费者） 。
- 客户端存根（Client Stub）：存放服务端地址信息，将客户端的请求参数数据信息打包成网络消息，再通过网络传输发送给服务端 。
- 服务端存根（Server Stub）：接收客户端发送过来的请求消息并进行解包，然后再调用本地服务进行处理 。
- 服务端（Server）：服务的真正提供者 。

### 具体的调用过程

![](/img/other/rpc.png)

- 服务消费者（client 客户端）通过本地调用的方式调用服务。
- 客户端存根（client stub）接收到调用请求后负责将方法、入参等信息序列化（组装）成能够进行网络传输的消息体 。
- 客户端存根（client stub）找到远程的服务地址，并且将消息通过网络发送给服务端。
- 服务端存根（server stub）收到消息后进行解码（反序列化操作） 。
- 服务端存根（server stub）根据解码结果调用本地的服务进行相关处理。
- 本地服务执行具体业务逻辑并将处理结果返回给服务端存根（server stub）。
- 服务端存根（server stub）将返回结果重新打包成消息（序列化）并通过网络发送至消费方。
- 客户端存根（client stub）接收到消息，并进行解码（反序列化）。
- 服务消费方得到最终结果 。

**RPC 框架的实现目标则是将上面的第一步以外的所有步骤完好地封装起来，也就是把调用、编码/解码的过程给封装起来，让用户感觉上像调用本地服务一样的调用远程服务。**

## RPC vs REST

### RPC 优点

- 支持多种编码和传输协议，可以针对不同的场景选择不同的设计方案，更加灵活可用。
- rpc 的传输效率更加高效，比 restful 更加简洁，节约带宽。（比如 thirft 中的 TCompactProtocol， **使用高效率的、密集的二进制编码格式进行数据传输, 比 json 更加高效**）
- 简化了交互逻辑。原来跨系统调用的时候，一般使用 http 的方式进行交互。程序员之间要反复交流，针对接口反复确认。最后花了很多时间在这个上面。而且交互代码会写的比较麻烦：拼接 URL 参数、写调用 http 代码、解析调用结果，如果出错还要写重试代码。使用 thrift 以后，整个这些操作都被封装到框架底层：针对接口的讨论，只要给出 idl ，剩余的事情都让机器去确认。同时，整个开发逻辑也极大简化，基本就几行代码。
- 接口更加明确，有 idl 这个天然的接口文档，少一个参数都编译不通过，大大减少了因为接口参数问题出现的 bug 。
- 可以建立长连接(比如建立长连接 TCP 通道)，不必每次通信都要像 http 一样去 3 次握手什么的，减少了网络开销。
- rpc 是建立在 TCP 协议的 socket 通信上的，而 web api 是建立在 HTTP/HTTPS 协议上的，rpc 天然地性能会更高。

### RPC 缺点

- 兼容性不如 REST，一般只能用于内部服务之间通信。

### 使用场景

- http: 对外提供的服务，更加规范、通用、易扩展、已维护，具有较高的安全性(https)。

- rpc: 对内提供的服务（如 BFF 端通信），尤其适用于需要进行大量数据交互的服务(thrift 提供高效的压缩协议，交互更加简洁，吞吐量更大)、 高频率交互的服务(可以考虑建立 TCP 长连接，比如即将开工的大权限系统)。

## RPC 常用框架

- RMI：Remote Method Invoking。JAVA 自带的远程方法调用工具，不过有一定的局限性，只能在 JAVA 语言使用。
- Hessian（基于 HTTP 的远程方法调用）：基于 HTTP 协议传输，在性能方面还不够完美
- Dubbo 国内阿里巴巴较早开源的服务治理的 Java rpc 框架，在国内得到了广泛的应用
- Motan 是新浪于 2016 年开源的一个 RPC 框架，Motan 跟 Dubbo 支持相同功能的同时，减少了部分扩展特性，类似于 Dubbo 的量身裁剪版
- brpc 是百度 17 年 9 月份开源的内部使用的 RPC 框架。
- Tars 腾讯出品的 RPC 框架，在腾讯内部用了十多年，涉及到各种业务使用场景。
- Thrift 是由 Facebook 开源的一个 RPC 框架，现在已经挂在 Apache 上。优点：1. 支持非常多语言，PHP、C++/Python/Java 、Ruby、Erlang、Node 等。2. 完整的 RPC 框架实现，用脚本生成通讯相关的 server 和 client 端框架代码，研发只需要专注在业务开发上。3、历史悠久，性能高效，可靠稳定。http://thrift.apache.org/
- gRPC Google 出品，是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C++、Java 、Go、Node、PHP、Python、ruby 等。基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。 http://doc.oschina.net/grpc

## 参考资料

[维基百科：远程过程调用](https://zh.wikipedia.org/wiki/%E9%81%A0%E7%A8%8B%E9%81%8E%E7%A8%8B%E8%AA%BF%E7%94%A8)
